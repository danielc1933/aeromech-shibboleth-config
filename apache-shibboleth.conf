#
# Apache VirtualHost configuration for web.aeromech.usyd.edu.au
# Shibboleth SP protecting /private with SAML authentication via Okta
#
# Install this file to /etc/httpd/conf.d/aeromech-shibboleth.conf
# (or include it from your main VirtualHost configuration)
#

# Redirect all plain-HTTP traffic to HTTPS
<VirtualHost *:80>
    ServerName web.aeromech.usyd.edu.au
    Redirect permanent / https://web.aeromech.usyd.edu.au/
</VirtualHost>

<VirtualHost *:443>
    ServerName web.aeromech.usyd.edu.au

    # ── TLS configuration ────────────────────────────────────────────────────
    SSLEngine on
    SSLCertificateFile      /etc/pki/tls/certs/aeromech.crt
    SSLCertificateKeyFile   /etc/pki/tls/private/aeromech.key
    # Uncomment and set if an intermediate/chain certificate is needed:
    # SSLCertificateChainFile /etc/pki/tls/certs/aeromech-chain.crt

    # Harden TLS: disable SSLv2/v3 and weak protocols
    SSLProtocol             all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite          HIGH:!aNULL:!MD5:!SEED:!IDEA:!RC4:!3DES
    SSLHonorCipherOrder     on

    # ── Document root ─────────────────────────────────────────────────────────
    DocumentRoot /var/www/html
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # ── Shibboleth handler ───────────────────────────────────────────────────
    # Make the /Shibboleth.sso handler available (required for SAML flows)
    <Location /Shibboleth.sso>
        SetHandler shib
    </Location>

    # ── Protected path: /private ─────────────────────────────────────────────
    # Require a valid Shibboleth session for everything under /private.
    # On first access the user will be redirected to Okta for authentication.
    <Location /private>
        AuthType shibboleth
        ShibRequestSetting requireSession 1
        # REMOTE_USER is set from the SAML attribute listed in REMOTE_USER
        # inside shibboleth2.xml (eppn, persistent-id, or targeted-id).
        Require shib-session
    </Location>

    # ── Optional: pass selected Shibboleth attributes to the application ──────
    # Uncomment the ShibUseHeaders lines if the application reads HTTP headers
    # rather than environment variables.
    #
    # <Location /private>
    #     ShibUseHeaders on
    # </Location>

    # ── Logging ───────────────────────────────────────────────────────────────
    ErrorLog  /var/log/httpd/aeromech-error.log
    CustomLog /var/log/httpd/aeromech-access.log combined

    # ── Security headers ──────────────────────────────────────────────────────
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set Referrer-Policy "no-referrer-when-downgrade"

</VirtualHost>
